//
//  NVMapViewController.m
//  nvpolyline
//
//  Created by William Lachance on 10-03-30.
//  Inspired by code and ideas from Craig Spitzkoff and Nicolas Neubauer 2009.
//

#import "NVMapViewController.h"
#import "NVPolylineAnnotationView.h"
#import <QuartzCore/QuartzCore.h>

@implementation NVMapViewController
- (id)initWithPoints:(NSArray *)points {
    self = [super init];
    _points = points;
    
    return self;
}
- (void) viewDidLoad {
    [[UIApplication sharedApplication] setStatusBarOrientation: UIInterfaceOrientationLandscapeRight];
}

-(CGRect)getScreenBoundsForCurrentOrientation {
    return [self getScreenBoundsForOrientation:[UIApplication sharedApplication].statusBarOrientation];
}

-(CGRect)getScreenBoundsForOrientation:(UIInterfaceOrientation)orientation {

    UIScreen *screen = [UIScreen mainScreen];
    CGRect fullScreenRect = screen.bounds; //implicitly in Portrait orientation.        

    if(orientation>UIInterfaceOrientationLandscapeRight) {
        NSLog(@"getScreenBoundsForOrientation: Face up and Face down Not supported, assuming portrait orientation");
    } else if (UIInterfaceOrientationIsLandscape(orientation)) {
        CGRect temp = CGRectZero;
        temp.size.width = fullScreenRect.size.height;
        temp.size.height = fullScreenRect.size.width;
        fullScreenRect = temp;      
    }

    return fullScreenRect;
}

- (void)loadView {
	[super loadView];
	
	_mapView = [[[MKMapView alloc] initWithFrame:[self getScreenBoundsForCurrentOrientation]] autorelease];
	[_mapView setDelegate:self];
	[self.view addSubview:_mapView];
    
    UIButton *button = [UIButton buttonWithType:UIButtonTypeRoundedRect];

    //[returnView addTarget:self action:@selector(backPressed)
     //forControlEvents:UIControlEventTouchUpInside];
    
    //set the position of the button
    UIView *returnView = [[UIView alloc] init];
    returnView.frame = CGRectMake(0, 0, 60, 300);
    returnView.backgroundColor = [UIColor lightGrayColor];

    UIView *bandReturnView = [[UIView alloc] init];
    bandReturnView.frame = CGRectMake(54, 0, 6, 300);
    bandReturnView.backgroundColor = [UIColor blackColor];

    UIView *buttonReturnView = [[UIView alloc] init];
    buttonReturnView.frame = CGRectMake(15, 30, 40, 40);
    buttonReturnView.backgroundColor = [[UIColor alloc] initWithPatternImage:[UIImage imageNamed:@"btnBack.png"]];
    
    UITapGestureRecognizer* tapRecognizer = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(handleTap:)];
	[buttonReturnView addGestureRecognizer:tapRecognizer];
	[tapRecognizer release];

    //set the button's title
    [button setTitle:@"Back" forState:UIControlStateNormal];
    
    [button addTarget:self action:@selector(backPressed)
     forControlEvents:UIControlEventTouchUpInside];
    
    //add the button to the view
    [_mapView addSubview:button];
    [_mapView addSubview:returnView];
    [_mapView addSubview:bandReturnView];
    [_mapView addSubview:buttonReturnView];


	// a drive from Dorval to Westmount, Quebec, Canada... as generated by Google Earth
	/*NSArray *points = [NSArray arrayWithObjects:
					   [[[CLLocation alloc] initWithLatitude:45.43894 longitude:-73.7396] autorelease],
					   [[[CLLocation alloc] initWithLatitude:45.44073 longitude:-73.73998] autorelease],
					   [[[CLLocation alloc] initWithLatitude:45.44082000000001 longitude:-73.73992] autorelease],
					   [[[CLLocation alloc] initWithLatitude:45.44382 longitude:-73.74069] autorelease],
					   [[[CLLocation alloc] initWithLatitude:45.44612 longitude:-73.74122] autorelease],
					   [[[CLLocation alloc] initWithLatitude:45.44612 longitude:-73.74122] autorelease],
					   [[[CLLocation alloc] initWithLatitude:45.44628 longitude:-73.74119] autorelease],
					   nil];*/
					   
	NVPolylineAnnotation *annotation = [[[NVPolylineAnnotation alloc] initWithPoints:_points mapView:_mapView] autorelease];
	[_mapView addAnnotation:annotation];	
	
	// use some magic numbers to create a map region
	MKCoordinateRegion region;
	region.span.longitudeDelta = 0.01;
	region.span.latitudeDelta = 0.01;
	//region.center.latitude = 19.297595;
	//region.center.longitude = -99.080307;
	region.center.latitude = [[_points objectAtIndex:0] coordinate].latitude;
	region.center.longitude = [[_points objectAtIndex:0] coordinate].longitude;
	//NSLog(@"%i", [[_points objectAtIndex:0] coordinate].latitude);
	[_mapView setRegion:region];
}

- (void)handleTap:(UITapGestureRecognizer*)recognizer
{
    // Do Your thing. 
    if (recognizer.state == UIGestureRecognizerStateEnded)
    {
    	[self dismissModalViewControllerAnimated:true];
    }
}

-(void)backPressed {
    [self dismissModalViewControllerAnimated:true];
}

- (MKAnnotationView *)mapView:(MKMapView *)mapView viewForAnnotation:(id <MKAnnotation>)annotation {

	if ([annotation isKindOfClass:[NVPolylineAnnotation class]]) {
		return [[[NVPolylineAnnotationView alloc] initWithAnnotation:annotation mapView:_mapView] autorelease];
	}
		 
	return nil;
}

// Find any polyline annotation and update its region.
- (void)updatePolylineAnnotationView {
	for (NSObject *a in [_mapView annotations]) {
		if ([a isKindOfClass:[NVPolylineAnnotation class]]) {
			NVPolylineAnnotation *polyline = (NVPolylineAnnotation *)a;
			
			NSObject *pv = (NSObject *)[_mapView viewForAnnotation:polyline];
			if ([pv isKindOfClass:[NVPolylineAnnotationView class]]) {
				NVPolylineAnnotationView *polylineView = 
					(NVPolylineAnnotationView *)[_mapView viewForAnnotation:polyline];
				
				[polylineView regionChanged];
			}
		}		
	}
}

- (BOOL)shouldAutorotateToInterfaceOrientation: (UIInterfaceOrientation)interfaceOrientation {
	// Return YES for supported orientations
	return (interfaceOrientation == UIDeviceOrientationLandscapeLeft);
}

- (void)dealloc {
    [super dealloc];
}

# pragma mark - MKMapViewDelegate

- (void) mapView:(MKMapView *)mapView didAddAnnotationViews:(NSArray *)views {
	// fixes that some marker are behind the polyline
	for (int i=0; i<[views count]; i++) {
		MKAnnotationView *view = [views objectAtIndex:i];
		if ([view isKindOfClass:[NVPolylineAnnotationView class]]) {
			[[view superview] sendSubviewToBack:view];
			
			/* In iOS version above 4.0 we need to update the polyline view after it
			 has been added to the mapview and it ready to be displayed. */
			NSString *reqSysVer = @"4.0";
			NSString *currSysVer = [[UIDevice currentDevice] systemVersion];
			if ([currSysVer compare:reqSysVer options:NSNumericSearch] != NSOrderedAscending) {
				[self updatePolylineAnnotationView];
			}
		}
	}
}

- (void)mapView:(MKMapView *)mapView regionDidChangeAnimated:(BOOL)animated {
	/* In iOS version above 4.0 we need to update the polyline view after a region change */
	NSString *reqSysVer = @"4.0";
	NSString *currSysVer = [[UIDevice currentDevice] systemVersion];
	if ([currSysVer compare:reqSysVer options:NSNumericSearch] != NSOrderedAscending) {
		[self updatePolylineAnnotationView];
	}
}

@end
